<section class="mt-2">
  <ul>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a routerLink="/main">Dashboard</a></li>
        <li class="breadcrumb-item">
          <a routerLink (click)="navigate('METER REPLACEMENT', '23')">Meter Change</a>
        </li>
        <li class="breadcrumb-item">
          <a style="color: lightslategray">Meter Change Details</a>
        </li>
      </ol>
    </nav>
  </ul>
</section>

<section *ngIf="applicationTypeCode === 'SMR' || isFaReceived == '1'; else errorTemplate">
  <form #meterChangeForm="ngForm" class="form">
    <div class="page__content shadow p-3 position-relative dis-flex-colu">
      <h2 class="title-2">Meter Change Details</h2>
      <div *ngIf="data && data.length">
        <div class="two-column-grid">
          <div class="left-column">
            <div class="inner-div">
              <label>Work Order No :</label>
              <p>{{ data[0]?.workorderNo }}</p>
            </div>
          </div>
          <div class="right-column">
            <div class="inner-div">
              <label>Work Description :</label>
              <p>{{ data[0]?.workDescription }}</p>
            </div>
          </div>
        </div>
      </div>

      <h3>Old Meter Details :</h3>
      <div style="overflow: auto; width: 100%; border: 2px solid #c2c2c2; margin-top: 1rem;">
        <table class="table table-bordered text-center">
          <thead style="background-color: #f2f2f2; color: #3e3e3e">
            <tr>
              <th scope="col">Account Id</th>
              <th scope="col">Badge Number</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of oldAccountMappingData">
              <td>{{ item.accountId }}</td>
              <td>{{ item.badgeNumber }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div style="overflow: auto; width: 100%; border: 2px solid #c2c2c2; margin-top: 1rem;">
        <table class="table table-bordered text-center">
          <thead style="background-color: #f2f2f2; color: #3e3e3e">
            <tr>
              <th scope="col" style="width: 10%;">Sequence no</th>
              <th scope="col" style="width: 30%;">Register Id</th>
              <th scope="col" style="width: 20%;">Unit of Measure</th>
              <th scope="col" style="width: 25%;">Time of Use</th>
              <th scope="col" style="width: 15%;">Reading</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of oldMeterData">
              <td>{{ item.registerReadSeqNo }}</td>
              <td>{{ item.registerId }}</td>
              <td>{{ item.registerUom }}</td>
              <td>{{ item.registerTou }}</td>
              <td>
                <input
                  type="text"
                  class="form-control"
                  [ngClass]="{'error-highlight': registerReading.invalid && (registerReading.dirty || registerReading.touched)}"
                  [ngModelOptions]="{ standalone: true }"
                  [(ngModel)]="item.registerReading"
                  required
                  #registerReading="ngModel"
                  (keydown)="allowOnlyNumbers($event)"
                  (input)="restrictInput($event, item)"
                  (blur)="validatePFValue(item)"
                />
                <div *ngIf="registerReading.invalid && (registerReading.dirty || registerReading.touched)" class="text-danger">
                  Reading is required.
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="text-center" style="margin-top: 1rem;" *ngIf="newMeterData.length==0;">
        <button class="btn btn-primary" (click)="meterReplicatorAndMeterValidatorInCcb()" [disabled]="isRequestInProgress">
          Meter Validator
        </button>
      </div>
      <div *ngIf="errorMessage" class="alert alert-danger mt-3 text-center">
        {{ errorMessage }}
      </div>
      <h3 *ngIf="newMeterData.length > 0;">New Meter Details :</h3>
      <div style="overflow: auto; width: 100%; border: 2px solid #c2c2c2; margin-top: 1rem;" *ngIf="newMeterData.length > 0">
        <table class="table table-bordered text-center" >
          <thead style="background-color: #f2f2f2; color: #3e3e3e">
            <tr>
              <th scope="col" style="width: 40%;">Account Id</th>
              <th scope="col" style="width: 40%;">Badge Number</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of newAccountMappingData">
              <td>{{ item.accountId }}</td>
              <td>{{ item.badgeNumber }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div style="overflow: auto; width: 100%; border: 2px solid #c2c2c2; margin-top: 1rem;" *ngIf="newMeterData.length > 0">
        <table class="table table-bordered text-center">
          <thead style="background-color: #f2f2f2; color: #3e3e3e">
            <tr>
              <th scope="col" style="width: 10%;">Sequence no</th>
              <th scope="col" style="width: 30%;">Register Id</th>
              <th scope="col" style="width: 20%;">Unit of Measure</th>
              <th scope="col" style="width: 25%;">Time of Use</th>
              <th scope="col" style="width: 15%;">Reading</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of newMeterData">
              <td>{{ item.registerReadSeqNo }}</td>
              <td>{{ item.registerId }}</td>
              <td>{{ item.registerUom }}</td>
              <td>{{ item.registerTou }}</td>
              <td>
                <input
                type="text"
                class="form-control"
                [ngClass]="{'error-highlight': newRegisterReading.invalid && (newRegisterReading.dirty || newRegisterReading.touched)}"
                [ngModelOptions]="{ standalone: true }"
                [(ngModel)]="item.registerReading"
                required
                #newRegisterReading="ngModel"
                (keydown)="allowOnlyNumbers($event)"
                (input)="restrictInput($event, item)"
                (blur)="validatePFValue(item)"
                />
                <div *ngIf="newRegisterReading.invalid && (newRegisterReading.dirty || newRegisterReading.touched)" class="text-danger">
                  Reading is required.
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="form-group mt-3" *ngIf="newMeterData.length > 0">
        <label for="readingDate" class="left-label">Reading Date:</label>
        <div class="date-picker-container">
          <input
            type="date"
            style="width: 15rem;"
            class="form-control"
            name="selectedDate"
            [(ngModel)]="selectedDate"
            [min]="minDate"
            [max]="maxDate"
            (ngModelChange)="validateDate($event)"
            required
          />
          <div *ngIf="dateError">
            <small class="text-danger">{{ dateError }}</small>
          </div>
        </div>
      </div>
      <div *ngIf="submitError" class="alert alert-danger mt-3 text-center">
        {{ submitError }}
      </div>
      <div class="btn-box mt-4 pb-4" *ngIf="newMeterData.length > 0">
        <button
          type="button"
          class="btn btn-primary btn-sm"
          (click)="submitForm()"
          [disabled]="isButtonDisabled"
        >
          Submit
        </button>
        <button
          type="button"
          class="btn clor btn-primary btn-sm"
          (click)="navigate('METER REPLACEMENT', '23')"
        >
          Close
        </button>
      </div>
    </div>
  </form>
</section>

<ng-template #errorTemplate>
  <div class="page__content shadow p-3 position-relative dis-flex-colu">
    <h2 class="title-2">Meter Change Details</h2>
    <p class="alert alert-danger mt-3">
      Request to initiate meter replacement details from CCB.
    </p>
  </div>
</ng-template>
