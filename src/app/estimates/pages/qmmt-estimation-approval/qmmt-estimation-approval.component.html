<div class="page-1">
    <section class="mt-2">
      <ul>
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item">
              <a routerLink="/main/dashboard">Dashboard </a>
            </li>
            <li class="breadcrumb-item">
              <a style="color: lightslategray">Quarterly Maintenance MT Estimation Approval Form</a>
            </li>
          </ol>
        </nav>
      </ul>
    </section>
    <section *ngIf="data && data.serviceRegistration">
      <!-- <button
        class="btn btn-sm"
        style="background-color: #4472c4; color: white; float: right"
        (click)="printPageArea('printForm')"
      >
        Print
      </button> -->
      <form class="form" id="printForm">
        <div class="page__content shadow p-3 position-relative dis-flex-colu">
          <h2 class="title-2">Quarterly Maintenance MT Estimation Approval Form</h2>
      
        <!-- Cost estimation report  -->
        <div class="page__content p-1 position-relative dis-flex-colu" >
          <h3><strong>Cost Estimation Report</strong></h3>
         <div class="two-row-grid single-row-grid mt-3" >
          <div class="left-div" *ngFor="let item of data.estimationRegisteredDTO">
            <!-- <div class="inner-div">
              <label>Name & Address</label>
              <p>{{ data.serviceRegistration.applicantName }} , {{ data.serviceRegistration.address }}</p>
            </div> -->
            <div class="inner-div">
              <label>Dop Category</label>
              <p>{{ workCategoryName ? workCategoryName : "-" }}</p>
            </div>
            <div class="inner-div">
              <label>Work Execution Method</label>
              <p>
                {{
                  item.woExecutionMethodName === "null"
                    ? "-"
                    : item.woExecutionMethodName
                }}
              </p>
            </div>
            <div class="inner-div">
              <label>Estimation No</label>
              <p>{{ item.estimationNo === "null" ? "-" : item.estimationNo }}</p>
            </div>
            <div class="inner-div">
              <label>Estimation Date</label>
              <p>
                {{ item.estimationDate === "null" ? "-" : item.estimationDate }}
              </p>
            </div>
            <div class="inner-div">
              <label>Purpose of Estimate</label>
              <p>
                {{
                  item.estimationWorkDesc === "null" ? "-" : item.estimationWorkDesc
                }}
              </p>
            </div>
          </div>
        </div>
    
        <!-- LT-Part A -Extension of LT line  -->
        <div class="page__content  position-relative dis-flex-colu" style="margin-top: 3%;">
          <h2 class="title-2"> Regular </h2>
          <div class="heading mt-2" *ngFor="let e of regularArray">
            <div>
              <h1>
                {{ e.estimate.workType }}- {{ e.estimate.workPart }}-
                {{ e.estimate.workscopeDescription }}
              </h1>
            </div>
    
            <div style="display: flex; flex-wrap: wrap; overflow: auto">
              <table
                class="table text-center"
                style="margin-top: 1rem; width: 100%; flex-wrap: wrap"
              >
                <thead>
                  <tr>
                    <th scope="col">Rate Type</th>
                    <th scope="col">Description of Material</th>
                    <th scope="col">Quantity</th>
                    <th scope="col">Unit</th>
                    <th scope="col">Rate</th>
                    <th scope="col">Materials Amount</th>
                    <th scope="col">Labour Rate</th>
                    <th scope="col">Labour Amount</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of e.data">
                    <td>{{ item.rateType }}</td>
                    <td style="text-align: left">
                      {{ item.materialCode }} - {{ item.materialName }}
                    </td>
                    <td>{{ item.quantity }}</td>
                    <td>{{ item.materialUnit }}</td>
                    <td>{{ item.materialRate }}</td>
                    <td>{{ item.materailAmount =='null'?0:item.materailAmount}}</td>
                    <td>{{ item.labourRate }}</td>
                    <td>{{ item.labourAmount }}</td>
                  </tr>
                </tbody>
                <tr>
                  <td>
                    <h3>Total</h3>
                  </td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td>{{ e.estimate.materialCost }}</td>
                  <td></td>
                  <td>{{ e.estimate.labourCost }}</td>
                </tr>
              </table>
            </div>
          </div>
        </div>
        <div
          *ngIf="creditArray.length"
        
        >
        <h2>Credit</h2>
        <div class="heading mt-2" *ngFor="let e of creditArray; index as i">
          <div class="row">
            <div>
              <h3>
                {{ e.estimate.workType }}- {{ e.estimate.workPart }}-
                {{ e.estimate.workscopeDescription }}
              </h3>
            </div>
            <div *ngIf="e.estimate.isSelectAccountHead && !isAE" class="col" >
              <mat-form-field appearance="outline" class="square-dropdown">
                <input
                  #creditInput
                  type="text"
                  matInput
                  placeholder="Please Search credit account head"
                  [formControl]="creditAccountHeadControls[i]"
                  [matAutocomplete]="auto"
                  (focus)="creditAccountHeadControls[i].markAsTouched()"
                />
                
                <mat-autocomplete #auto="matAutocomplete">
                  <mat-option *ngIf="filteredCreditAccountHeadData.length === 0" disabled>
                    No options found
                  </mat-option>
        
                  <mat-option
                    *ngFor="let accountHeadDataItem of filteredCreditAccountHeadData"
                    [value]="accountHeadDataItem.accountHeadMasterId"
                    (click)="onAccountHeadSelected(accountHeadDataItem, i)"
                  >
                    {{ accountHeadDataItem?.accountHeadCode }} - {{ accountHeadDataItem?.accountHeadDescription }}
                  </mat-option>
                </mat-autocomplete>
                <mat-error *ngIf="creditAccountHeadControls[i].invalid && creditAccountHeadControls[i].touched" class="custom-error">
                  Please select a credit account head.
                </mat-error>
              </mat-form-field>
            </div>
            <!-- <p *ngIf="!e.estimate.isSelectAccountHead">Code : {{ getAccountHeadDetails(e.estimate.accountHeadMasterId)?.accountHeadCode }}</p>
            <p *ngIf="!e.estimate.isSelectAccountHead">Description : {{ getAccountHeadDetails(e.estimate.accountHeadMasterId)?.accountHeadDescription }}</p> -->
          </div>
    
            <div style="display: flex; flex-wrap: wrap; overflow: auto " >
              <table
                class="table text-center"
                style="margin-top: 1rem;  width: 100%; flex-wrap: wrap"
              >
                <thead>
                  <tr>
                    <th scope="col">Rate Type</th>
                    <th scope="col">Description of Material</th>
                    <th scope="col">Quantity</th>
                    <th scope="col">Unit</th>
                    <th scope="col">Rate</th>
                    <th scope="col">Materials Amount</th>
                    <th scope="col">Labour Rate</th>
                    <th scope="col">Labour Amount</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of e.data">
                    <td>{{ item.rateType }}</td>
                    <td style="text-align: left">
                      {{ item.materialCode }} - {{ item.materialName }}
                    </td>
                    <td>{{ item.quantity }}</td>
                    <td>{{ item.materialUnit }}</td>
                    <td>{{ item.materialRate }}</td>
                    <td>{{ item.materailAmount =='null'?0 :item.materailAmount}}</td>
                    <td>{{ item.labourRate }}</td>
                    <td>{{ item.labourAmount }}</td>
                  </tr>
                </tbody>
                <tr>
                  <td>
                    <h1>Total</h1>
                  </td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td>{{ e.estimate.materialCost }}</td>
                  <td></td>
                  <td>{{ e.estimate.labourCost }}</td>
                </tr>
              </table>
            </div>
          </div>
        </div>
    
        <!-- Typical Cost Data Sheet -->
    
       <div class="page__content  position-relative dis-flex-colu" style="margin-top: 0%;">
          <h2 class="title-2">Typical Cost Data Sheet</h2>
          <div
            class="two-row-grid mt-3"
            style="
              grid-template-columns: 1fr;
              justify-items: flex-end;
              /* padding: 1rem; */
            "
          >
            <div class="data-sheet">
              <div class="inner-div-t" *ngIf="data.estimationRegisteredDTO[0]?.woExecutionMethodCode === 'PT'">
                <label>Escom Material Cost(A)</label>
                <p>
                  {{data.estimationRegisteredDTO[0]?.escomMaterialCost}}
                </p>
              </div>
              
              <div class="inner-div-t" *ngIf="data.estimationRegisteredDTO[0]?.woExecutionMethodCode=== 'PT'">
                <label>Agency Material Cost (A)</label>
                <p>
                  {{ data.estimationRegisteredDTO[0]?.agencyMaterialCost}}
                </p>
              </div>            
              <div class="inner-div-t">
                <label>Material Cost (A)</label>
                <p>
                  {{ data.estimationRegisteredDTO[0]?.estimationMaterialCost }}
                </p>
              </div>
              <div class="inner-div-t">
                <label>Labour Cost (B)</label>
                <p>
                  {{ data.estimationRegisteredDTO[0]?.estimationLabourCost }}
                </p>
              </div>
              <div class="inner-div-t">
                <label>Basic Rate (C)=(A+B)</label>
                <p>
                  {{ basicRate}}
                </p>
              </div>
              <div class="inner-div-t" *ngFor="let item of addChargesBeforeTotalLabour">
                <label>
                    <ng-container *ngIf="item.chargeType == 'PERCENTAGE'">
                        {{ item.chargeTypeValue }}% {{ item.additionalChargeName }}
                    </ng-container>
                    <ng-container *ngIf="item.chargeType == 'FLAT'">
                        {{ item.additionalChargeName }}
                    </ng-container>
                    <span *ngIf="item.additionalChargeName === 'Area Specific Loading on Basic Rates'">(D)</span>
                    <span *ngIf="item.additionalChargeName === 'GST'">(E)</span>
                </label>
                <p>{{ item.amount }}</p>
            </div>
              <div class="inner-div-t">
                <label>Cost Of Estimate (F) = (C + D + E)</label>
                <p>
                  {{ data.estimationRegisteredDTO[0]?.totalLabourCharges ==='null'?0:data.estimationRegisteredDTO[0]?.totalLabourCharges }}
                </p>
              </div>
              <div
                class="inner-div-t"
                *ngFor="let item of addChargesAfterTotalLabour"
              >
                <label *ngIf="item.chargeType == 'PERCENTAGE'"
                  >{{ item.chargeTypeValue }}%
                  {{ item.additionalChargeName }}</label
                >
                <label *ngIf="item.chargeType == 'FLAT'">{{
                  item.additionalChargeName
                }}</label>
                <p>{{ item.amount }}</p>
              </div>
              <div class="inner-div-t">
                <label><strong>Total Cost Of Estimate (F + Sum of all charges below F)</strong></label>
                <p>
                 <strong>{{ data?.estimationRegisteredDTO[0]?.estimationTotalCost }}</strong>
                </p>
              </div>
              <div class="inner-div-t">
                <label>(Amount in Words)</label>
                <p>
                  {{ data?.estimationRegisteredDTO[0]?.estimationTotalCost |numberToWords}}
                </p>
              </div>
            </div>
          </div>
        </div>
    
        <!-- Budget Details -->
        <div
          class="page__content  position-relative dis-flex-colu"
          *ngIf="!isAE"
        >
          <h2>Budget Details</h2>
        </div>
        <div >
          <div
            class="col-lg-6 mt-2"
            style="width: 100% !important; padding: 0.5rem"
            *ngIf="!isAE"
          >
            <div class="grid two-row-grid">
              <div class="left-div">
                <div class="inner-div">
                  <label>Divisional Acc. Head No.*</label>
                  <select
                    #budgetSelect
                    class="form-select"
                    name="budget"
                    style="width: 100%"
                    [formControl]="budgetControl"
                    (change)="getDivisionalBudgetData($event.target.value)"
                  >
                    <option selected *ngIf="!selectedValue" disabled>--select--</option>
                    <option selected *ngIf="selectedValue">
                      {{ selectedValue }}
                    </option>
                    <option
                      *ngFor="let data of budgetData"
                      [value]="data.accountHeadMasterId"
                    >
                      {{ data?.accountHeadCode }}&nbsp;({{
                        data?.accountHeadDescription
                      }})
                    </option>
                  </select>
                </div>
                <div *ngIf="showError && !budgetControl.value" class="star" style="text-align: right;">
                  Divisional Acc. Head No. is required.
                </div>
    
                <div class="inner-div" *ngIf="isBudgetDetails">
                  <label>Divisional Acc. Head Description</label>
                  <p>{{ divisionalBudgetData?.accountHeadDescription }}</p>
                </div>
                <div class="inner-div" *ngIf="isBudgetDetails">
                  <label>Division Budget Head</label>
                  <p>{{ divisionalBudgetData?.divisionalBudgetHead }}</p>
                </div>
                <div class="inner-div" *ngIf="isBudgetDetails">
                  <label>Budget Type</label>
                  <p>{{ divisionalBudgetData?.budgetWorkType }}</p>
                </div>
              </div>
              <div>
                <div class="inner-div" *ngIf="isBudgetDetails">
                  <label>Total Budget Amount (A)</label>
                  <p>{{ divisionalBudgetData?.totalBudgetAmount }}</p>
                </div>
                <div class="inner-div" *ngIf="isBudgetDetails">
                  <label>Work Order issue Amount (B)</label>
                  <p>
                    {{
                      divisionalBudgetData?.workOrderIssueAmount != "null"
                        ? divisionalBudgetData?.workOrderIssueAmount
                        : "-"
                    }}
                  </p>
                </div>
                <div class="inner-div" *ngIf="isBudgetDetails">
                  <label>Reserved Amount (C)</label>
                  <p>
                    {{ divisionalBudgetData?.totalReserveAmount != 'null' ? 
                        divisionalBudgetData?.totalReserveAmount : '-' }}
                  </p>
                </div>
                <div class="inner-div" *ngIf="isBudgetDetails">
                  <label>Balance Amount ( A - ( B + C) )</label>
                  <p>
                    {{ divisionalBudgetData?.balanceAmount ? divisionalBudgetData?.balanceAmount : '-' }}
                  </p>
                </div>
                <div class="inner-div" *ngIf="isBudgetDetails">
                  <label>Total Expenditure Amount (D)</label>
                  <p>
                    {{ divisionalBudgetData?.totalExpenditureAmount != 'null' ? 
                        divisionalBudgetData?.totalExpenditureAmount : '0' }}
                  </p>
                </div>
                <div class="inner-div" *ngIf="isBudgetDetails">
                  <label>Actual Balance Amount (A - D)</label>
                  <p>
                    {{ divisionalBudgetData?.totalBudgetAmount - divisionalBudgetData?.totalExpenditureAmount || 
                      divisionalBudgetData?.totalBudgetAmount - divisionalBudgetData?.totalExpenditureAmount == 0 ? 
                      divisionalBudgetData?.totalBudgetAmount - divisionalBudgetData?.totalExpenditureAmount : '-' }}
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
    
        <!-- Labour Details -->
    
        <div
          class="heading"
          style="
            flex-direction: row;
            justify-content: space-between;
          
          "
        >
          <h2>
            Labour Details &nbsp;
            <button style="border: none" (click)="toggleDisplayTableIf()">
              <img src="assets/plus.svg" alt="" />
            </button>
          </h2>
        </div>
    
        <div
          style="
            flex-wrap: wrap;
            overflow: auto;
      
          "
          *ngIf="!toggleTable"
        >
          <!-- [ngStyle]="{ display: toggleTable ? 'none' : '' }" -->
          <table
            class="table text-center"
            style="margin-top: 1rem; width: 100%; flex-wrap: wrap"
          >
            <thead style="background-color: #dfdfdf">
              <tr>
                <th scope="col">Description of Material</th>
                <th scope="col">Description of Labours</th>
                <th scope="col">Unit</th>
                <th scope="col">Labour Rate</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let labourDetail of labourDetails">
                <td>{{ labourDetail.materialName }}</td>
                <td>{{ labourDetail.labourName }}</td>
                <td>{{ labourDetail.labourUnit }}</td>
                <td>{{ labourDetail.labourRate }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div></div>
    
        <br /><br />
        <div
          class="heading"
          style="
             flex-direction: row;
            justify-content: space-between;
          "
        >
          <h2>History</h2>
        </div>
    
        <div
          style="
            display: flex;
            flex-wrap: wrap;
            overflow: auto;
            
          " >
          <table class="table text-center" style="margin-top: 1rem; width: 100%; flex-wrap: wrap">
            <thead style="background-color: #dfdfdf">
              <tr>
                <th>S. No.</th>
                <th scope="col">PROCESS TYPE</th>
                <th scope="col">PROCESSED DATE</th>
                <th scope="col">PROCESSED BY</th>
                <th scope="col">FORWARD/RETURN TO</th>
                <th scope="col">REMARKS</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let historyData of history?.estimationProcessFlowHistory; index as i"
              [ngStyle]="{'background-color': historyData.estimationStatus === '1' && historyData.estimationFlowType === 'REGENERATED' ? '#ffd8fe' : 'none'}">
                <td>{{ i + 1 }}</td>
                <td>
                  <b *ngIf="historyData.estimationFlowType == 'GENERATED' || historyData.estimationFlowType == 'REGENERATED'">
                    <a target="_blank" 
                    routerLink="/main/estimation-report/{{historyData.estimationRegisteredId}}/{{ data.serviceRegistration.serviceRegistrationId }}">
                    {{ historyData.estimationFlowType }}</a>
                  </b>
                  <b *ngIf="historyData.estimationFlowType != 'GENERATED' && historyData.estimationFlowType != 'REGENERATED'">
                    {{ historyData.estimationFlowType }}
                  </b>
                </td>
                <td>{{ historyData.processedDate | date : "medium" }}</td>
                <td>{{ historyData.processedByDesigcode }}</td>
                <td>{{ historyData.processSendToDesigcode !== "null" ? historyData.processSendToDesigcode : '-' }}</td>
                <td>{{ historyData?.remarks }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div
        class="heading"
        style="
          display: flex;
          flex-direction: row;
          justify-content: space-between;
        "
      >
        <h3><b>Approve/Forward/Edit</b></h3>
      </div>
      
      <!-- Display Text -->
      <div style="
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
        padding: 0.5rem;
      ">
        <h6 style="font-size: 0.9rem; font-weight: 600">
          {{ displayText }}
        </h6>
      </div>
      
      <!-- Radio Buttons -->
      <div style="
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        gap: 2rem;
        justify-content: center;
        padding: 0.5rem;
      ">
        <label class="sm" *ngIf="isApproved && isDivisionalBudgetSCValid">
          <input [value]="1" [(ngModel)]="sh" name="sh" type="radio" />
          Approve
        </label>
        <label class="sm" *ngIf="isDivisionalBudgetSCValid">
          <input [value]="2" [(ngModel)]="sh" name="sh" type="radio" (change)="radioType('forward')" />
          Forward
        </label>
        <label class="sm" *ngIf="!isAE">
          <input [value]="3" [(ngModel)]="sh" name="sh" type="radio" [checked]="!isChecked"
            (change)="radioType('return')" />
          Return
        </label>
        <label class="sm">
          <input [value]="4" [(ngModel)]="sh" name="sh" type="radio" (change)="radioType('edit')" />
          Edit
        </label>
      </div>
      
      <!-- Approve Section -->
      <div class="text-center purple" *ngIf="sh == 1 && isApproved">
        <div class="container text-center">
          <div class="row">
            <div class="col" style="display: flex; flex-direction: column; gap: 1rem">
              <h3>Approve By</h3>
              <h3>Approve Date</h3>
              <h3>Remarks</h3>
            </div>
            <div class="col" style="display: flex; flex-direction: column; gap: 1rem">
              <input type="text" class="form-control" style="width: 80%"[ngModelOptions]="{standalone: true}" [(ngModel)]="forwardData.forwardBy" />
              <input type="date" class="form-control" style="width: 80%"[ngModelOptions]="{standalone: true}" [(ngModel)]="forwardData.forwardDate" />
              <textarea class="form-control" style="width: 80%"[ngModelOptions]="{standalone: true}" [(ngModel)]="forwardData.remarks"></textarea>
            </div>
          </div>
        </div>
        <div class="radio-button">
          <button 
          [disabled]="isLoading" 
          class="btn btn-md" 
          style="background-color: #4472c4; color: white" 
          (click)="approve()">
            Approve
          </button>
        </div>
      </div>
      
      <!-- Forward Section -->
      <div *ngIf="sh == 2">
        <div class="container text-center">
          <div class="row">
            <div class="col" style="display: flex; flex-direction: column; gap: 1rem">
              <h4>Forwarded By</h4>
              <h4>Forwarded To</h4>
              <h4>Forwarded Date</h4>
              <h4>Remarks</h4>
            </div>
            <div class="col" style="display: flex; flex-direction: column; gap: 1rem">
              <input type="text" class="form-control" style="width: 80%" [ngModelOptions]="{standalone: true}" [(ngModel)]="forwardData.forwardBy" />
              <select class="form-select" style="width: 80%" name="forwardTo" [formControl]="forwardControl">
                <option value="" disabled>select</option>
                <option *ngFor="let optionItem of forwardData.forwardTo" [value]="optionItem.designationCode">
                  {{ optionItem.designationCode }}
                </option>
              </select>
              <input type="date" class="form-control" style="width: 80%" [ngModelOptions]="{standalone: true}" [(ngModel)]="forwardData.forwardDate" />
              <textarea class="form-control" style="width: 80%" [ngModelOptions]="{standalone: true}" [(ngModel)]="forwardData.remarks"></textarea>
            </div>
          </div>
        </div>
        <div class="radio-button">
          <button  [disabled]="isLoading" class="btn btn-md" style="background-color: #4472c4; color: white" (click)="forward()">
            Forward
          </button>
        </div>
      </div>
       <!-- Return Section -->
       <div *ngIf="sh == 3">
        <div class="container text-center">
          <div class="row">
            <div class="col" style="display: flex; flex-direction: column; gap: 2rem">
              <h4>Return By</h4>
              <h4>Return To</h4>
              <h4>Return Date</h4>
              <h4>Remarks</h4>
            </div>
            <div class="col" style="display: flex; flex-direction: column; gap: 2rem">
              <input type="text" class="form-control" style="width: 80%" id="" [(ngModel)]="forwardData.forwardBy"
                name="forwardBy" />
              <select class="form-select" style="width: 80%" name="forwardTo" [formControl]="returnControl">
                <option value="">select</option>
                <option *ngFor="let optionItem of forwardData.forwardTo" [value]="optionItem.designationCode">
                  {{ optionItem.designationCode }}
                </option>
              </select>
  
              <input type="text" class="form-control" style="width: 80%" id="" [(ngModel)]="forwardData.forwardDate"
                name="forwardDate" />
              <textarea type="text" class="form-control" style="width: 80%" id="" [(ngModel)]="forwardData.Remarks"
                name="remarks"></textarea>
            </div>
          </div>
        </div>
        <div class="radio-button">
          <button class="btn btn-lg radio-button" style="background-color: #4472c4; color: white" (click)="return()">
            Return
          </button>
        </div>
      </div>
  
      <!-- Edit Section -->
      <div *ngIf="sh == 4">
        <div class="radio-button">
          <button class="btn btn-md" style="background-color: #4472c4; color: white" (click)="moveToEstimate()">
            Edit
          </button>
        </div>
      </div>
      
      </div> 
      </div>
      </form>
    </section>
    </div>